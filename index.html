<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="node_modules/vis/dist/vis.js"></script>
    <link href="node_modules/vis/dist/vis.css" rel="stylesheet" type="text/css" />

    <style type="text/css">
        #mynetwork {
            width: 1920px;
            height: 1200px;
            border: 1px solid lightgray;
        }
    </style>
</head>
<body>
<div id="mynetwork"></div>

<script type="text/javascript">

    function getLabel(nodeData) {
        var split = nodeData.itemIdentifier.split(/[\/#]/);
        return split[split.length - 1];
    }
    
    $.get("http://localhost:8080/graph", function(data, status) {
        var nodeDataDict = {};  // lookup by uuid
        var nodeVisDict = {};  // lookup by uuid

        var edgeDict = {};

        var nodes = new vis.DataSet([]);
        var edges = new vis.DataSet([]);
        
        // create a network
        var container = document.getElementById('mynetwork');

        var vis_data  = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            interaction: {
                hover: true
            },
            physics: {
                barnesHut: {
                    gravitationalConstant: -20000
                }
            }
        };

        var network = new vis.Network(container, vis_data, options);

        function addNode(nodeData) {
            if (!(nodeData.uuid in nodeVisDict)) {
                nodeVis = {
                    id: nodeData.uuid,
                    label: getLabel(nodeData)
                };

                nodeVisDict[nodeData.uuid] = nodeVis;
                nodeDataDict[nodeData.uuid] = nodeData;
                nodes.add(nodeVis);
            }
        }

        function addEdges(nodeData, createNodes) {
            function putEdge(nodeFrom, nodeTo, type) {
                var edgeVis = {
                    from: nodeFrom.uuid,
                    to: nodeTo.uuid,
                    label: type
                };

                if (!(edgeVis.label in edgeDict)) {
                    edgeDict[edgeVis.label] = {};
                }
                if (!(edgeVis.from in edgeDict[edgeVis.label])) {
                    edgeDict[edgeVis.label][edgeVis.from] = {}
                }
                if (!(edgeVis.to in edgeDict[edgeVis.label][edgeVis.from])) {
                    edgeDict[edgeVis.label][edgeVis.from][edgeVis.to] = edgeVis;
                    edges.add(edgeVis);
                }
            }

            $.each(nodeData.out, function(i, edge) {
                $.get(edge.node.href, function(nodeOut, status) {
                    addNode(nodeOut);
                    putEdge(nodeData, nodeOut, edge.type);
                });
            });

            $.each(nodeData.in, function(i, edge) {
                $.get(edge.node.href, function(nodeIn, status) {
                    addNode(nodeIn);
                    putEdge(nodeIn, nodeData, edge.type);
                });
            });
        }

        data.content = data.content.slice(0, 1);
        $.each(data.content, function(i, nodeData) {
            addNode(nodeData);
        });

        $.each(data.content, function(i, nodeData) {
            addEdges(nodeData, false);
        });

        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                var id = params.nodes[0];

                $.get(nodeDataDict[id].links[0].href, function(nodeData, status) {
                    addEdges(nodeData, true);
                });
            }
        });
    });
</script>
</body>
</html>
